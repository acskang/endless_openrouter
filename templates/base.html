{% load static %}
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
      {% block title %}Ahading{% endblock %}
    </title>
    <link rel="shortcut icon"
          type="image/x-icon"
          href="{% static 'img/favicon.ico' %}">
    {% block extra_head %}
    {% endblock extra_head %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
          rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    {% block extra_css %}
    {% endblock extra_css %}
  </head>
  <body>
    {% csrf_token %}
    <nav class="navbar">
      <div class="nav-container d-flex justify-content-between align-items-center w-100">
        <a href="/" class="logo">TheSysM</a>
        <div class="nav-links">
          {% if user.is_authenticated %}
            <a href="{% url 'phrase:index' %}">Movie Clip</a>
            <a href="{% url 'account:logout' %}">Logout</a>
          {% else %}
            <a onclick="openModal('loginModal')">Login</a>
            <a onclick="openModal('signupModal')">SignUp</a>
          {% endif %}
        </div>
      </div>
    </nav>
    {% block content %}
    {% endblock content %}
    <main class="main-content">
      <div class="welcome-section">
        <h1>Welcome to TheSysM</h1>
        {% if user.is_authenticated %}
          <p>í™˜ì˜í•©ë‹ˆë‹¤, {{ user.username }}ë‹˜!</p>
        {% else %}
          <p>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</p>
        {% endif %}
      </div>
    </main>
    <!-- Login/Signup Modal -->
    <!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="loginModal" class="modal" style="display: none;">
      <div class="modal-content">
        <span class="close" onclick="closeModal('loginModal')">&times;</span>
        <form class="modal-form" method="post" action="{% url 'account:login' %}">
          {% csrf_token %}
          <h2>ë¡œê·¸ì¸</h2>
          <!-- ë©”ì‹œì§€ í‘œì‹œ -->
          <div id="loginMessages">
            {% if messages %}
              {% for message in messages %}
                {% if 'login' in message.tags or 'error' in message.tags %}
                  {% if message.tags == 'error' or 'login' in message.tags %}
                    <div class="toast error"
                         style="display: block;
                                position: relative;
                                top: auto;
                                right: auto;
                                margin-bottom: 1rem">{{ message }}</div>
                  {% elif message.tags == 'success' %}
                    <div class="toast success"
                         style="display: block;
                                position: relative;
                                top: auto;
                                right: auto;
                                margin-bottom: 1rem">{{ message }}</div>
                  {% elif message.tags == 'info' %}
                    <div class="toast info"
                         style="display: block;
                                position: relative;
                                top: auto;
                                right: auto;
                                margin-bottom: 1rem">{{ message }}</div>
                  {% endif %}
                {% endif %}
              {% endfor %}
            {% endif %}
          </div>
          <input type="text"
                 name="email_or_username"
                 placeholder="ì´ë©”ì¼ ë˜ëŠ” ì‚¬ìš©ìëª…"
                 value="{% if form_data.email_or_username %}{{ form_data.email_or_username }}{% endif %}"
                 required>
          <input type="password" name="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
          <button type="submit">ë¡œê·¸ì¸</button>
        </form>
      </div>
    </div>
    <!-- íšŒì›ê°€ì… ëª¨ë‹¬ -->
    <div id="signupModal" class="modal" style="display: none;">
      <div class="modal-content">
        <span class="close" onclick="closeModal('signupModal')">&times;</span>
        <h2>íšŒì›ê°€ì…</h2>
        <!-- ë©”ì‹œì§€ í‘œì‹œ -->
        <div id="signupMessages">
          {% if messages %}
            {% for message in messages %}
              {% if 'signup' in message.tags %}
                {% if message.tags == 'error' or 'signup' in message.tags %}
                  <div class="toast error"
                       style="display: block;
                              position: relative;
                              top: auto;
                              right: auto;
                              margin-bottom: 1rem">{{ message }}</div>
                {% elif message.tags == 'success' %}
                  <div class="toast success"
                       style="display: block;
                              position: relative;
                              top: auto;
                              right: auto;
                              margin-bottom: 1rem">{{ message }}</div>
                {% endif %}
              {% endif %}
            {% endfor %}
          {% endif %}
        </div>
        <form class="modal-form"
              id="signupForm"
              method="post"
              action="{% url 'account:signup' %}">
          {% csrf_token %}
          <input id="signupUsername"
                 name="username"
                 type="text"
                 placeholder="ì‚¬ìš©ìëª…"
                 value="{% if form_data.username %}{{ form_data.username }}{% endif %}"
                 required>
          <input id="signupEmail"
                 name="email"
                 type="email"
                 placeholder="ì´ë©”ì¼"
                 value="{% if form_data.email %}{{ form_data.email }}{% endif %}"
                 required>
          <input id="signupPassword"
                 name="password"
                 type="password"
                 placeholder="ë¹„ë°€ë²ˆí˜¸"
                 required>
          <input id="signupPasswordConfirm"
                 name="password_confirm"
                 type="password"
                 placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸"
                 required>
          <button type="submit">íšŒì›ê°€ì…</button>
        </form>
      </div>
    </div>
    <!-- Real Chatting -->
    <!-- Chat Floating Button -->
    <button id="chatFloatingBtn"
            class="chat-floating-btn"
            {% if user.is_authenticated %}style="display: flex;"{% else %}style="display: none;"{% endif %}>ğŸ’¬</button>
    <!-- Chat Modal - í•­ìƒ ë Œë”ë§ë¨ -->
    <div id="chatModal" class="chat-modal">
      <div class="chat-header">
        <div class="chat-title">TheSysM Support</div>
        <button id="closeChat" class="close-chat">âœ•</button>
      </div>
      <div id="chatMessages" class="chat-messages">
        <div class="message received">
          <div class="message-content">
            <p>ë°˜ê°€ì›Œìš”! ë‚œ AI Yaya ì—ìš”..</p>
          </div>
        </div>
      </div>
      <div class="chat-input">
        <input type="text"
               id="messageInput"
               class="message-input"
               placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
        <button id="sendMessage" class="send-btn">â¤</button>
      </div>
    </div>
    <!-- ìë™ ëª¨ë‹¬ ì—´ê¸° ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì˜¤ë¥˜ ë©”ì‹œì§€ì— ë”°ë¼ ëª¨ë‹¬ ìë™ ì—´ê¸°
      document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸ” DOM ë¡œë“œ ì™„ë£Œ, ëª¨ë‹¬ ìƒíƒœ í™•ì¸ ì¤‘...');
        
        // ë¡œê·¸ì¸ ê´€ë ¨ ë©”ì‹œì§€ê°€ ìˆëŠ”ì§€ í™•ì¸
        const loginMessages = document.getElementById('loginMessages');
        const signupMessages = document.getElementById('signupMessages');
        
        let shouldOpenLoginModal = false;
        let shouldOpenSignupModal = false;
        let isAutoOpen = false; // ìë™ ì—´ê¸°ì¸ì§€ í™•ì¸í•˜ëŠ” í”Œë˜ê·¸

        // ì„œë²„ì—ì„œ ì „ë‹¬ëœ modal_state í™•ì¸
        {% if modal_state %}
          isAutoOpen = true; // ì„œë²„ì—ì„œ ì˜¨ ìƒíƒœì´ë¯€ë¡œ ìë™ ì—´ê¸°
          {% if modal_state == 'login' %}
            shouldOpenLoginModal = true;
            console.log('âœ… ì„œë²„ì—ì„œ ë¡œê·¸ì¸ ëª¨ë‹¬ ìƒíƒœ ê°ì§€ë¨');
          {% elif modal_state == 'signup' %}
            shouldOpenSignupModal = true;
            console.log('âœ… ì„œë²„ì—ì„œ íšŒì›ê°€ì… ëª¨ë‹¬ ìƒíƒœ ê°ì§€ë¨');
          {% endif %}
        {% else %}
          // ë©”ì‹œì§€ ê¸°ë°˜ ê°ì§€ (í´ë°±)
          if (loginMessages && loginMessages.children.length > 0) {
            shouldOpenLoginModal = true;
            isAutoOpen = true;
            console.log('ğŸ“ ë¡œê·¸ì¸ ì˜¤ë¥˜ ë©”ì‹œì§€ ê°ì§€ë¨');
          }
          
          if (signupMessages && signupMessages.children.length > 0) {
            shouldOpenSignupModal = true;
            isAutoOpen = true;
            console.log('ğŸ“ íšŒì›ê°€ì… ì˜¤ë¥˜ ë©”ì‹œì§€ ê°ì§€ë¨');
          }
          
          // Django ë©”ì‹œì§€ íƒœê·¸ ê¸°ë°˜ ê°ì§€
          {% if messages and not user.is_authenticated %}
            {% for message in messages %}
              {% if 'login' in message.tags %}
                shouldOpenLoginModal = true;
                isAutoOpen = true;
                console.log('ğŸ·ï¸ Django ë©”ì‹œì§€ íƒœê·¸ì—ì„œ ë¡œê·¸ì¸ ì˜¤ë¥˜ ê°ì§€ë¨');
              {% elif 'signup' in message.tags %}
                shouldOpenSignupModal = true;
                isAutoOpen = true;
                console.log('ğŸ·ï¸ Django ë©”ì‹œì§€ íƒœê·¸ì—ì„œ íšŒì›ê°€ì… ì˜¤ë¥˜ ê°ì§€ë¨');
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endif %}
        
        // ì „ì—­ í•¨ìˆ˜ë¡œ ìë™ ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜ ì •ì˜
        window.openModalWithContent = function(modalId) {
          const modal = document.getElementById(modalId);
          if (!modal) {
            console.error(`Modal with id '${modalId}' not found`);
            return;
          }

          // ëª¨ë‹¬ í‘œì‹œ (ì´ˆê¸°í™”í•˜ì§€ ì•Šê³ )
          modal.style.display = "block";
          document.body.style.overflow = "hidden";
          
          // ëª¨ë‹¬ ìƒíƒœ ì„¤ì •
          if (typeof window.modalState !== 'undefined') {
            window.modalState.currentModal = modalId;
            window.modalState.isAnimating = true;
          }

          // í˜ì´ë“œì¸ íš¨ê³¼
          setTimeout(() => {
            modal.classList.add("modal-show");
            if (typeof window.modalState !== 'undefined') {
              window.modalState.isAnimating = false;
            }
          }, 10);

          // í¬ì»¤ìŠ¤ ê´€ë¦¬ (ê¸°ì¡´ ê°’ì´ ìˆëŠ” ê²½ìš°ë¥¼ ê³ ë ¤)
          setTimeout(() => {
            if (modalId === 'loginModal') {
              const emailInput = modal.querySelector('input[name="email_or_username"]');
              const passwordInput = modal.querySelector('input[name="password"]');
              
              if (emailInput && emailInput.value.trim()) {
                passwordInput.focus();
              } else if (emailInput) {
                emailInput.focus();
              }
            } else if (modalId === 'signupModal') {
              const usernameInput = modal.querySelector('#signupUsername');
              const emailInput = modal.querySelector('#signupEmail');
              const passwordInput = modal.querySelector('#signupPassword');
              
              // ì´ë¯¸ ì…ë ¥ëœ ê°’ì´ ìˆëŠ” ì²« ë²ˆì§¸ ë¹ˆ í•„ë“œì— í¬ì»¤ìŠ¤
              if (usernameInput && !usernameInput.value.trim()) {
                usernameInput.focus();
              } else if (emailInput && !emailInput.value.trim()) {
                emailInput.focus();
              } else if (passwordInput) {
                passwordInput.focus();
              }
            }
          }, 200);

          console.log("Modal opened with content:", modalId);
        };
        
        // ëª¨ë‹¬ ì—´ê¸° (ìš°ì„ ìˆœìœ„: íšŒì›ê°€ì… > ë¡œê·¸ì¸)
        if (shouldOpenSignupModal) {
          console.log('ğŸš€ íšŒì›ê°€ì… ëª¨ë‹¬ ì—´ê¸° (ë‚´ìš© ìœ ì§€)');
          setTimeout(function() {
            if (isAutoOpen && typeof openModalWithContent === 'function') {
              // ìë™ ì—´ê¸° ì‹œ ë‚´ìš©ì„ ìœ ì§€í•˜ë©° ì—´ê¸°
              openModalWithContent('signupModal');
            } else if (typeof openModal === 'function') {
              // ìˆ˜ë™ ì—´ê¸° ì‹œ ì´ˆê¸°í™”í•˜ë©° ì—´ê¸°
              openModal('signupModal');
            }
          }, 200);
        } else if (shouldOpenLoginModal) {
          console.log('ğŸš€ ë¡œê·¸ì¸ ëª¨ë‹¬ ì—´ê¸° (ë‚´ìš© ìœ ì§€)');
          setTimeout(function() {
            if (isAutoOpen && typeof openModalWithContent === 'function') {
              // ìë™ ì—´ê¸° ì‹œ ë‚´ìš©ì„ ìœ ì§€í•˜ë©° ì—´ê¸°
              openModalWithContent('loginModal');
            } else if (typeof openModal === 'function') {
              // ìˆ˜ë™ ì—´ê¸° ì‹œ ì´ˆê¸°í™”í•˜ë©° ì—´ê¸°
              openModal('loginModal');
            }
          }, 200);
        }
        
        // ë””ë²„ê¹… ì •ë³´
        console.log('ğŸ” ëª¨ë‹¬ ìƒíƒœ ì²´í¬ ê²°ê³¼:', {
          shouldOpenLoginModal,
          shouldOpenSignupModal,
          isAutoOpen,
          hasLoginMessages: loginMessages ? loginMessages.children.length : 0,
          hasSignupMessages: signupMessages ? signupMessages.children.length : 0,
          modalState: '{{ modal_state|default:"none" }}',
          userAuthenticated: {{ user.is_authenticated|yesno:"true,false" }}
        });
      });
      
      // í¼ ì œì¶œ í›„ ë¦¬ë””ë ‰ì…˜ ì²˜ë¦¬
      window.addEventListener('beforeunload', function() {
        // í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œ ëª¨ë‹¬ ìƒíƒœ ì´ˆê¸°í™”
        if (typeof window.modalState !== 'undefined') {
          window.modalState.preventClose = false;
        }
      });
    </script>
    <script src="{% static 'js/modals.js' %}"></script>
    <script src="{% static 'js/chat.js' %}"></script>
    <script src="{% static 'js/script.js' %}"></script>
    {% block extra_js %}
    {% endblock %}
  </body>
</html>
